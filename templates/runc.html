{%- extends "base.html" %}
{%- block title %}Docker sandbox escape{% endblock %}
{%- block challenges_menu %}active{% endblock %}
{%- block content %}
    <div class="jumbotron" style="margin-bottom: 0px;">
        <h2>RunC challenge</h2>
        <hr>
        <div class="container">
            <div id="loadingBox">
                <div class="d-flex justify-content-center">
                    <div class="spinner-border" role="status">
                        <span class="sr-only">Loading...</span>
                    </div>
                </div>
                </br>
                <div class="d-flex justify-content-center">
                    <p> Building container. It might take few seconds.</p>
                </div>
            </div>
        </div>
        <button type="button" class="btn btn-dark">Revert</button>
        <button type="button" class="btn btn-dark">Shutdown</button>
    </div>
    <script>
        var intervalId = 0;
        var terminal = document.createElement('iframe')
        var timeout_counter = 60

        function keepAlive() {
            var req = new XMLHttpRequest()
            req.open('POST', '/api/container/keepalive', false)
            req.send(JSON.stringify({
                'id': '{{ name }}'
            }))
        }

        function loadTerminal() {
            document.getElementById('loadingBox').innerHTML = "<iframe width=\"100%\" height=\"500px\" src=\"/challenges/runc/{{ name }}/\" ></iframe>"
            setInterval(keepAlive, 30000)
        }

        function sendCheckRequest() {
            if (timeout_counter == 0) {
                loadingBox.innerHTML = "<p class=\"d-flex justify-content-center\" >Something wen't wrong :(</p>"
                clearInterval(intervalId)
            }
            var req = new XMLHttpRequest()
            req.open('GET', '/challenges/runc/{{ name }}/', false)
            req.send()
            if (req.status == 200) {
                loadTerminal()
                clearInterval(intervalId)
            }
            timeout_counter--
        }

        function sendRunRequest() {
            var req = new XMLHttpRequest()
            req.open('POST', '/api/container/run', false)
            req.send(JSON.stringify({
                'challenge': 'runc'
            }))
        }

        (function startChallenge() {
            var req = new XMLHttpRequest()
            req.open('GET', '/challenges/runc/{{ name }}/', false)
            req.send()
            if (req.status != 200) {
                sendRunRequest()
                intervalId = setInterval(sendCheckRequest, 3000)
            } else {
                loadTerminal()
                terminal.src = '/challenges/runc/{{ name }}/'
            }
        })()
    </script>
    {%- with messages = get_flashed_messages() %}
        {%- if messages %}
            {%- for msg in messages %}
                <p>{{ msg }}</p>
            {%- endfor %}
        {%- endif %}
    {%- endwith %}
{%- endblock %}